<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>不動產共有物處分計算機</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

<div id="app" class="p-6 max-w-4xl mx-auto">
  <h1 class="text-2xl font-bold mb-4">不動產共有物處分計算機</h1>

  <!-- 規則說明 -->
  <div class="mb-8 bg-white rounded-xl p-6 shadow">
    <h2 class="text-xl font-semibold mb-4">處分條件說明</h2>

    <div class="space-y-4">

      <div>
        <h3 class="font-medium text-lg text-blue-800 mb-2">處分條件（符合下列任一條件即可）</h3>
        <ul class="list-disc pl-5 space-y-2">
          <li>條件一：同意處分之共有人數超過共有人總數 1/2，且其應有部分合計超過共有部分 1/2</li>
          <li>條件二：同意處分之應有部分合計超過共有部分 2/3</li>
        </ul>
        <div class="mt-2 text-sm text-gray-600">
          參照：<a href="https://law.moj.gov.tw/LawClass/LawSingle.aspx?pcode=D0060001&flno=34-1" target="_blank" class="text-blue-600 hover:underline">土地法第34-1條</a>
        </div>
      </div>

      <div>
        <h3 class="font-medium text-lg text-blue-800 mb-2">公同共有特別規定</h3>
        <ul class="list-disc pl-5 space-y-2">
          <li>每個公同共有群組需先符合以下任一條件，才視為該群組同意處分：
            <ul class="list-circle pl-5 mt-2 space-y-1">
              <li>同意處分之共有人數超過該群組共有人總數 1/2，且其應有部分合計超過該群組共有部分 1/2</li>
              <li>同意處分之應有部分合計超過該群組共有部分 2/3</li>
            </ul>
          </li>
          <li>當公同共有群組同意處分時：
            <ul class="list-circle pl-5 mt-2 space-y-1">
              <li>人數計算：只計入實際同意的成員人數</li>
              <li>面積計算：依實際同意成員的持分比例計算</li>
            </ul>
          </li>
          <li>當公同共有群組不同意處分時：
            <ul class="list-circle pl-5 mt-2 space-y-1">
              <li>人數及面積均不計入總計算</li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- 所有權人列表 -->
  <div class="mb-8">
    <div class="space-y-4">
      <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
        <div class="font-medium text-blue-800">目前總持分：{{ formatShare(calculateTotalShare()) }}</div>
        <div v-if="totalShareWarning" class="text-orange-600 text-sm mt-1">{{ totalShareWarning }}</div>
      </div>
      <div v-for="(owner, index) in owners" :key="index" class="border p-4 rounded-xl bg-white shadow">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-4">
            <select v-model="owner.type" class="border rounded-md px-3 py-2 shadow-sm">
              <option value="separate">分別共有</option>
              <option value="joint">公同共有</option>
            </select>
            <div class="flex items-center space-x-2">
              <input v-model.number="owner.numerator" type="number" placeholder="分子"
                     class="border rounded-md px-3 py-2 w-20 shadow-sm" />
              <span>/</span>
              <input v-model.number="owner.denominator" type="number" placeholder="分母"
                     class="border rounded-md px-3 py-2 w-20 shadow-sm" />
            </div>
          </div>
          <button @click="removeOwner(index)" class="text-red-500 hover:underline">移除</button>
        </div>

        <!-- 分別共有 -->
        <div v-if="owner.type === 'separate'" class="space-y-2">
          <input v-model="owner.name" type="text" placeholder="姓名"
                 class="border rounded-md px-3 py-2 w-full shadow-sm" />
          <label class="flex items-center space-x-2">
            <input v-model="owner.agree" type="checkbox" />
            <span>同意處分</span>
          </label>
        </div>

        <!-- 公同共有 -->
        <div v-if="owner.type === 'joint'" class="space-y-4">
          <div class="space-y-2">
            <div v-for="(member, memberIndex) in owner.members" :key="memberIndex"
                 class="flex items-center space-x-2 bg-gray-50 p-2 rounded">
              <input v-model="member.name" type="text" placeholder="成員姓名"
                     class="border rounded-md px-3 py-1 w-40 shadow-sm" />
              <div class="flex items-center space-x-2">
                <input v-model.number="member.numerator" type="number" placeholder="分子"
                       class="border rounded-md px-3 py-1 w-16 shadow-sm" />
                <span>/</span>
                <input v-model.number="member.denominator" type="number" placeholder="分母"
                       class="border rounded-md px-3 py-1 w-16 shadow-sm" />
              </div>
              <label class="flex items-center space-x-2">
                <input v-model="member.agree" type="checkbox" />
                <span>同意處分</span>
              </label>
              <button @click="removeJointMember(owner, memberIndex)"
                      class="text-red-500 hover:underline">移除</button>
            </div>
          </div>
          <button @click="addJointMember(owner)"
                  class="text-blue-600 hover:underline">新增公同共有成員</button>
          <div v-if="getJointGroupShareError(owner)"
               class="text-red-500 text-sm">
            {{ getJointGroupShareError(owner) }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-6 flex justify-between items-center">
    <button @click="addOwner" class="px-4 py-2 rounded-lg font-semibold shadow bg-gray-200 hover:bg-gray-300">
      ➕ 新增所有權人
    </button>
    <button @click="calculateResult" class="px-4 py-2 rounded-lg font-semibold shadow bg-blue-600 text-white hover:bg-blue-700">
      計算結果
    </button>
  </div>

  <div v-if="totalShareError" class="mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
    {{ totalShareError }}
  </div>

  <div class="mt-6 text-xl font-semibold" :class="{'text-green-600': result.success, 'text-red-600': !result.success}" v-if="result.message">
    <div v-html="result.message"></div>
  </div>
</div>

<script>
  const { createApp, ref, watch } = Vue

  createApp({
    setup() {
      const owners = ref([
        {
          type: 'separate',
          numerator: 0,
          denominator: 1,
          name: '',
          agree: false,
          members: []
        }
      ])

      const result = ref({ message: '', success: false })
      const totalShareError = ref('')
      const totalShareWarning = ref('')

      function addOwner() {
        owners.value.push({
          type: 'separate',
          numerator: 0,
          denominator: 1,
          name: '',
          agree: false,
          members: []
        })
      }

      function removeOwner(index) {
        owners.value.splice(index, 1)
      }

      function addJointMember(owner) {
        owner.members.push({
          name: '',
          numerator: 0,
          denominator: 1,
          agree: false
        })
      }

      function removeJointMember(owner, memberIndex) {
        owner.members.splice(memberIndex, 1)
      }

      function getJointGroupShareError(group) {
        if (!group.members || group.members.length === 0) return null

        const totalShare = group.members.reduce((sum, m) => {
          if (m.denominator === 0) return sum
          return sum + (m.numerator / m.denominator)
        }, 0)

        if (totalShare > 1) {
          return `⚠️ 警告：此群組總持分 ${totalShare.toFixed(4)} 超過 1/1`
        } else if (totalShare < 1) {
          return `⚠️ 警告：此群組總持分 ${totalShare.toFixed(4)} 尚未達到 1/1`
        }
        return null
      }

      function checkJointGroupConsent(group) {
        const totalMembers = group.members.length
        if (totalMembers === 0) return false

        let totalShare = 0
        let agreeShare = 0
        let validMembers = 0

        group.members.forEach(member => {
          if (member.denominator === 0) return
          const share = member.numerator / member.denominator
          totalShare += share
          if (member.agree) {
            agreeShare += share
          }
          validMembers++
        })

        // 如果群組內部持分不等於 1，視為無效
        if (Math.abs(totalShare - 1) > 0.0001) {
          return {
            passed: false,
            agreeShare: 0,
            totalShare: 0,
            error: `群組內部持分必須等於 1/1（目前：${totalShare.toFixed(4)}）`
          }
        }

        if (totalShare === 0 || validMembers === 0) return {
          passed: false,
          agreeShare: 0,
          totalShare: 0,
          error: '群組內無有效成員'
        }

        const agreeMembers = group.members.filter(m => m.agree).length

        const rule1 = agreeMembers > validMembers / 2 && agreeShare > totalShare / 2
        const rule2 = agreeShare > totalShare * (2/3)

        return {
          passed: rule1 || rule2,
          agreeShare,
          totalShare,
          error: null
        }
      }

      function formatShare(share) {
        if (typeof share !== 'number') return '0'
        return share.toFixed(4)
      }

      const calculateTotalShare = () => {
        return owners.value.reduce((sum, o) => {
          if (o.denominator === 0) return sum
          return sum + (o.numerator / o.denominator)
        }, 0)
      }

      const validateTotalShare = () => {
        const total = calculateTotalShare()
        if (total > 1) {
          totalShareError.value = `⚠️ 警告：總持分面積 ${total.toFixed(4)} 超過 1/1`
          totalShareWarning.value = ''
        } else if (total < 1) {
          totalShareError.value = ''
          totalShareWarning.value = `⚠️ 注意：總持分面積 ${total.toFixed(4)} 尚未達到 1/1`
        } else {
          totalShareError.value = ''
          totalShareWarning.value = ''
        }
      }

      watch(owners, () => {
        validateTotalShare()
      }, { deep: true })

      const calculateResult = () => {
        const total = calculateTotalShare()
        if (total > 1) {
          result.value = {
            message: '❌ 無法計算：總持分面積超過 1/1',
            success: false
          }
          return
        }

        if (total < 1) {
          result.value = {
            message: '❌ 無法計算：總持分面積尚未達到 1/1（目前：' + total.toFixed(4) + '）',
            success: false
          }
          return
        }

        let totalAgreeShare = 0
        let totalAgreeCount = 0
        let totalOwnerCount = 0
        let errors = []

        owners.value.forEach(owner => {
          if (owner.type === 'joint') {
            const validMembers = owner.members.filter(m => m.denominator !== 0).length
            totalOwnerCount += validMembers

            const groupConsent = checkJointGroupConsent(owner)

            if (groupConsent.error) {
              errors.push(`公同共有群組錯誤：${groupConsent.error}`)
            } else if (groupConsent.passed) {
              const agreeMembers = owner.members.filter(m => m.agree).length
              totalAgreeCount += agreeMembers
              const groupAgreeShare = groupConsent.agreeShare / groupConsent.totalShare
              totalAgreeShare += (owner.numerator / owner.denominator) * groupAgreeShare
            }
          } else {
            totalOwnerCount++
            if (owner.agree) {
              totalAgreeCount++
              totalAgreeShare += (owner.numerator / owner.denominator)
            }
          }
        })

        if (errors.length > 0) {
          result.value = {
            message: '❌ 無法計算：<br>' + errors.join('<br>'),
            success: false
          }
          return
        }

        const rule1 = totalAgreeCount > totalOwnerCount / 2 && totalAgreeShare > total / 2
        const rule2 = totalAgreeShare > total * (2/3)

        let message = ''
        const success = rule1 || rule2

        if (rule1 && rule2) {
          message = '✅ 通過處分條件（條件一和條件二均成立）：<br>'
        } else if (rule1) {
          message = '✅ 通過處分條件（條件一成立）：<br>'
        } else if (rule2) {
          message = '✅ 通過處分條件（條件二成立）：<br>'
        } else {
          message = '❌ 不符合處分條件：<br>'
        }

        message += `- 總人數：${totalOwnerCount} 人（包含分別共有及公同共有成員）<br>`
        message += `- 同意人數：${totalAgreeCount} 人<br>`
        message += `- 同意人數比例：${totalAgreeCount}/${totalOwnerCount} (${(totalAgreeCount/totalOwnerCount*100).toFixed(2)}%)<br>`
        message += `- 同意面積比例：${(totalAgreeShare/total*100).toFixed(2)}%`

        result.value = { message, success }
      }

      return {
        owners,
        result,
        totalShareError,
        totalShareWarning,
        addOwner,
        removeOwner,
        addJointMember,
        removeJointMember,
        calculateResult,
        getJointGroupShareError,
        calculateTotalShare,
        formatShare
      }
    }
  }).mount('#app')
</script>

</body>
</html>
